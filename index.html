<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modrinth Mass Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1d21;
            --card-bg-color: #252a2e;
            --text-color: #e0e0e0;
            --text-muted-color: #9e9e9e;
            --primary-color: #2196F3;
            --primary-hover-color: #1976D2;
            --secondary-color: #FF9800;
            --secondary-hover-color: #F57C00;
            --link-color: #007bff;
            --link-hover-color: #0056b3;
            --border-color: #424242;
            --input-bg-color: #33373a;
            --success-color: #81c784;
            --error-color: #e57373;
            --code-bg-color: #373c3e;
            --override-bg-color: #3a3a3a;

            --border-radius: 6px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --transition-speed: 0.2s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.7;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 70px;
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 25px;
        }

        a {
            color: var(--link-color);
            text-decoration: none;
            transition: color var(--transition-speed) ease;
        }

        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        h1, h2 {
            color: #ffffff;
            margin-bottom: 25px;
            font-weight: 700;
        }

        h1 {
            text-align: center;
            font-size: 2.2em;
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.6em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: left;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            color: #f0f0f0;
            font-size: 0.95em;
        }

        .container {
            max-width: 850px;
            margin: auto;
            background: transparent;
        }

        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-bg-color);
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .site-title {
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
        }

        #main-header nav {
            display: flex;
            gap: 10px;
        }

        .nav-button {
            display: inline-block;
            padding: 8px 16px;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .nav-button:hover {
            background-color: var(--secondary-color);
            color: #ffffff;
            text-decoration: none;
            border-color: var(--secondary-hover-color);
            transform: translateY(-1px);
        }

        #preparation, #input, #results {
            scroll-margin-top: 80px;
        }

        .section-card {
            background-color: var(--card-bg-color);
            padding: 25px 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        .preparation-section ol {
            padding-left: 25px;
            margin-top: 15px;
        }

        .preparation-section li {
            margin-bottom: 15px;
        }

        pre {
            background-color: var(--code-bg-color);
            padding: 15px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            margin-top: 8px;
            border: 1px solid var(--border-color);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-muted-color);
        }

        textarea,
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 18px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            font-family: inherit;
            font-size: 1rem;
        }

        textarea::placeholder,
        input[type="text"]::placeholder {
            color: var(--text-muted-color);
            opacity: 0.7;
        }

        textarea:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .version-loader-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .version-loader-inputs > div {
            flex: 1;
            min-width: 150px;
        }

        .button {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            text-decoration: none;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .button:hover {
            text-decoration: none;
            transform: translateY(-2px);
        }
        .button:active {
            transform: translateY(0px);
        }

        #check-button.button-primary {
            width: 100%;
            margin-right: 0;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: #ffffff;
        }
        .button-primary:hover {
            background-color: var(--primary-hover-color);
            color: #ffffff;
        }

        .button-secondary {
            background-color: var(--secondary-color);
            color: #ffffff;
        }
        .button-secondary:hover {
            background-color: var(--secondary-hover-color);
            color: #ffffff;
        }

        .button-outline {
            background-color: transparent;
            color: var(--link-color);
            border: 1px solid var(--link-color);
        }
        .button-outline:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--link-color);
            border-color: var(--link-color);
        }

        .download-buttons {
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .file-upload-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-upload-section .button {
            margin-right: 0;
            margin-bottom: 0;
        }

        .file-name-display {
            flex-grow: 1;
            color: var(--text-muted-color);
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .or-separator {
            text-align: center;
            margin: 20px 0;
            color: var(--text-muted-color);
            position: relative;
            font-weight: 500;
        }

        .or-separator::before,
        .or-separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: var(--border-color);
        }

        .or-separator::before {
            left: 0;
        }

        .or-separator::after {
            right: 0;
        }

        .collapsible-container {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 18px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 50px;
        }

        .collapsible-container.expanded {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--input-bg-color);
            cursor: pointer;
            font-weight: 500;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
        }

        .collapsible-header:hover {
            background-color: #3f4448;
        }

        .collapsible-content {
            padding: 15px;
            padding-top: 0;
        }

        .collapsible-container.expanded .collapsible-content {
            padding-top: 15px;
        }

        .collapsible-container textarea {
            margin-bottom: 0;
        }

        #status-message {
            margin-top: 20px;
            font-weight: 500;
            text-align: center;
            min-height: 1.5em;
        }

        #progress-container {
            width: 100%;
            background-color: var(--input-bg-color);
            border-radius: var(--border-radius);
            margin-top: 20px;
            overflow: hidden;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            display: none;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            text-align: center;
            line-height: 25px;
            color: white;
            transition: width 0.3s ease-out;
            position: absolute;
            left: 0;
            top: 0;
        }

        #progress-text {
            position: relative;
            z-index: 1;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.9em;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .filter-controls input[type="text"],
        .filter-controls select {
            width: auto;
            flex-grow: 1;
            margin-bottom: 0;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--input-bg-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            border-style: hidden;
            box-shadow: 0 0 0 1px var(--border-color);
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: var(--card-bg-color);
            color: #ffffff;
            font-weight: 500;
            white-space: nowrap;
        }

        tr.available td:nth-child(2) {
            color: var(--success-color);
            font-weight: bold;
        }

        tr.not-available td:nth-child(2) {
            color: var(--error-color);
            font-weight: bold;
        }

        tr.other-issue td {
            background-color: var(--override-bg-color);
            color: var(--text-muted-color);
            font-style: italic;
        }

        tr.other-issue td:nth-child(2) {
            color: var(--text-muted-color);
        }

        td a {
            font-weight: 500;
        }

        #main-footer {
            text-align: center;
            padding: 20px 15px;
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted-color);
            font-size: 0.9em;
        }

        #main-footer p {
            margin: 0;
        }

        #main-footer a {
            color: var(--link-color);
            font-weight: 500;
        }
        #main-footer a:hover {
            color: var(--link-hover-color);
        }

        @media (max-width: 650px) {
            .header-content {
                flex-direction: column;
                padding: 15px;
            }

            .site-title {
                margin-bottom: 10px;
            }

            body {
                padding-top: 30px;
                padding-left: 15px;
                padding-right: 15px;
                padding-bottom: 25px;
            }
            #preparation, #input, #results {
                scroll-margin-top: 0px;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            .section-card {
                padding: 20px;
            }
            .version-loader-inputs {
                flex-direction: column;
                gap: 0;
            }
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-controls input[type="text"],
            .filter-controls select {
                width: 100%;
            }
            th, td {
                padding: 10px 8px;
            }
            .button {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            #check-button.button-primary {
                width: 100%;
            }
            .file-upload-section {
                flex-direction: column;
                align-items: stretch;
            }
            .file-upload-section .button {
                width: 100%;
            }
            .file-name-display {
                text-align: center;
            }
        }

        @media (max-width: 400px) {
            #main-header nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-button {
                padding: 6px 10px;
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <header id="main-header">
        <div class="header-content">
            <span class="site-title">Modrinth Mass Mod Checker</span>
            <nav>
                <a href="#preparation" class="nav-button">Preparation</a>
                <a href="#input" class="nav-button">Check Mods</a>
                <a href="#results" class="nav-button">Results</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div id="preparation" class="preparation-section section-card">
            <h2>Preparation Steps</h2>
            <ol>
                <li>
                    **Obtain an .mrpack file:**
                    <p>You can get an <code>.mrpack</code> file by first opening your Modrinth Minecraft Instance. After that, click on the 3 dots to the right of the Play button, then on <b>Export modpack</b> and save it to your desired destination. You can also download modpacks from the <a href="https://modrinth.com/modpacks" target="_blank" rel="noopener noreferrer">Official Modrinth Site</a>, which come in the <code>.mrpack</code> format.</p>
                </li>
                <li>
                    **Use this page:**
                    <p>To check your mods, firstly click the "Upload .mrpack File" button below and select your <code>.mrpack</code> file. Then, choose your desired <b>Target Loader</b> and <b>Target MC Version</b>. Finally, click the "Check for Updates" button to start the process.</p>
                    <p>Alternatively, you can manually enter mod IDs or slugs in the "Manual Mod Input" section below if you prefer not to upload a file.</p>
                </li>
            </ol>
        </div>

        <div id="input" class="input-section section-card">
            <h2>1. Upload Modpack or Enter Mods</h2>
            <div class="file-upload-section">
                <label for="mrpack-upload" class="button button-secondary">Upload .mrpack File</label>
                <input type="file" id="mrpack-upload" accept=".mrpack" style="display: none;">
                <span id="file-name-display" class="file-name-display">No file selected</span>
            </div>

            <p class="or-separator">OR</p>

            <div class="collapsible-container" id="manual-input-collapsible">
                <div class="collapsible-header">
                    <span>Manual Mod Input</span>
                    <span class="toggle-icon">+</span>
                </div>
                <div class="collapsible-content">
                    <label for="mod-list">Mod IDs or Slugs (one per line):</label>
                    <textarea id="mod-list" rows="10" placeholder="sodium&#10;fabric-api&#10;create&#10;JuksLGBQ&#10;G1hIVOrD"></textarea>
                </div>
            </div>

            <h2>2. Select Target Version</h2>
            <div class="version-loader-inputs">
                <div>
                    <label for="target-loader">Target Loader:</label>
                    <select id="target-loader">
                        <option value="fabric">Fabric</option>
                        <option value="forge">Forge</option>
                        <option value="quilt">Quilt</option>
                        <option value="neoforge">NeoForge</option>
                    </select>
                </div>
                <div>
                    <label for="target-mc-version">Target MC Version:</label>
                    <select id="target-mc-version">
                        <!-- Options will be dynamically populated here -->
                    </select>
                </div>
            </div>
            <button id="check-button" class="button button-primary">Check for Updates</button>
            <div id="progress-container">
                <div id="progress-bar"></div>
                <span id="progress-text"></span>
            </div>
            <p id="status-message"></p>
            <p id="rate-limit-note" style="color: var(--text-muted-color); font-style: italic; margin-top: 20px;">
                Note: The Modrinth API has a rate limit. If you are checking many mods, the API might block requests. Please wait a few minutes and try again if Errors occur.
            </p>
        </div>

        <div id="results" class="results-section section-card">
            <h2>3. Results</h2>
            <div class="filter-controls">
                <label for="filter-name">Filter by Name:</label>
                <input type="text" id="filter-name" placeholder="Enter mod name...">

                <label for="filter-availability">Filter by Availability:</label>
                <select id="filter-availability">
                    <option value="all">Show All</option>
                    <option value="available">Only Available</option>
                    <option value="not-available">Only Not Available</option>
                    <option value="other-issues">Other Issues (Errors, Not Found, Rate Limit hits)</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="results-table">
                    <thead>
                        <tr>
                            <th>Mod Name</th>
                            <th>Status for Target Version</th>
                            <th>Modrinth Link</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer id="main-footer">
        <p>
            Created by <a href="https://github.com/just-aqua" target="_blank" rel="noopener noreferrer">Aqua</a> - <a href="aquas.dev" target="_blank" rel="noopener noreferrer">Aquas Development</a>
        </p>
        <p>MIT License</p>
    </footer>

    <script>
        const modListTextarea = document.getElementById('mod-list');
        const targetMcVersionSelect = document.getElementById('target-mc-version');
        const targetLoaderSelect = document.getElementById('target-loader');
        const checkButton = document.getElementById('check-button');
        const statusMessage = document.getElementById('status-message');
        const resultsBody = document.getElementById('results-body');
        const filterNameInput = document.getElementById('filter-name');
        const filterAvailabilitySelect = document.getElementById('filter-availability');

        const mrpackUploadInput = document.getElementById('mrpack-upload');
        const fileNameDisplay = document.getElementById('file-name-display');

        const manualInputCollapsible = document.getElementById('manual-input-collapsible');
        const collapsibleHeader = manualInputCollapsible.querySelector('.collapsible-header');
        const toggleIcon = collapsibleHeader.querySelector('.toggle-icon');

        const progressBarContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        const rateLimitNote = document.getElementById('rate-limit-note');

        let allModResults = [];

        const delay = ms => new Promise(res => setTimeout(res, ms));

        checkButton.addEventListener('click', handleCheckUpdates);
        filterNameInput.addEventListener('input', applyFilters);
        filterAvailabilitySelect.addEventListener('change', applyFilters);
        targetLoaderSelect.addEventListener('change', populateMinecraftVersions);

        mrpackUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                statusMessage.textContent = `File "${file.name}" selected. Click "Check for Updates" to proceed.`;
                statusMessage.style.color = 'blue';
                await handleCheckUpdates();
            } else {
                fileNameDisplay.textContent = 'No file selected';
                statusMessage.textContent = '';
            }
        });

        collapsibleHeader.addEventListener('click', () => {
            manualInputCollapsible.classList.toggle('expanded');
            toggleIcon.textContent = manualInputCollapsible.classList.contains('expanded') ? '-' : '+';
        });

        async function populateMinecraftVersions() {
            targetMcVersionSelect.innerHTML = '<option value="">Loading Versions...</option>';
            targetMcVersionSelect.disabled = true;

            const gameVersionsApiUrl = 'https://api.modrinth.com/v2/tag/game_version';

            try {
                const response = await fetch(gameVersionsApiUrl);
                if (!response.ok) {
                    const statusText = response.statusText || 'Unknown Error';
                    console.error('Error fetching Minecraft versions:', statusText, response);
                    let errorMessage = `Error loading Minecraft versions: ${statusText}`;
                    if (response.status === 0) {
                        errorMessage += ' (Possibly a network or CORS issue)';
                    } else {
                        errorMessage += ` (Status: ${response.status})`;
                    }
                    displayStatusMessage(errorMessage, 'var(--error-color)');
                    return;
                }
                const versions = await response.json();

                const filteredVersions = versions
                    .filter(v => !v.version.includes('snapshot') && !v.version.includes('pre') && !v.version.includes('rc'))
                    .sort((a, b) => {
                        const parseVersion = (versionString) => versionString.split('.').map(Number);
                        const vA = parseVersion(a.version);
                        const vB = parseVersion(b.version);

                        for (let i = 0; i < Math.max(vA.length, vB.length); i++) {
                            const numA = vA[i] || 0;
                            const numB = vB[i] || 0;
                            if (numA !== numB) {
                                return numB - numA;
                            }
                        }
                        return 0;
                    });

                targetMcVersionSelect.innerHTML = '<option value="">Select a Version</option>';
                filteredVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.version;
                    option.textContent = version.version;
                    targetMcVersionSelect.appendChild(option);
                });

                displayStatusMessage('', '');
            } catch (error) {
                console.error('Error loading Minecraft versions:', error);
                displayStatusMessage(`Error loading Minecraft versions: ${error.message}. Please try again.`, 'var(--error-color)');
            } finally {
                targetMcVersionSelect.disabled = false;
            }
        }

        async function handleCheckUpdates() {
            let modIdentifiers = [];
            let extractedOverrides = [];

            const targetMcVersion = targetMcVersionSelect.value.trim();
            const targetLoader = targetLoaderSelect.value;

            if (!targetMcVersion) {
                displayStatusMessage('Please select a target Minecraft version.', 'var(--error-color)');
                return;
            }

            resultsBody.innerHTML = '';
            displayStatusMessage('Processing and checking mods...', 'var(--secondary-color)');
            checkButton.disabled = true;
            mrpackUploadInput.disabled = true;
            targetLoaderSelect.disabled = true;
            targetMcVersionSelect.disabled = true;
            allModResults = [];

            progressBarContainer.style.display = 'flex';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            try {
                const file = mrpackUploadInput.files[0];
                if (file) {
                    const processedData = await processMrpackFile(file);
                    modIdentifiers = processedData.modIdentifiers;
                    extractedOverrides = processedData.overrides;
                    modListTextarea.value = modIdentifiers.join('\n');
                } else {
                    modIdentifiers = modListTextarea.value.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                }

                if (modIdentifiers.length === 0 && extractedOverrides.length === 0) {
                    displayStatusMessage('No mods found to check. Please enter mod IDs or upload an .mrpack file.', 'var(--error-color)');
                    progressBarContainer.style.display = 'none';
                    return;
                }

                let completedRequests = 0;
                const totalRequests = modIdentifiers.length;

                const modCheckPromises = modIdentifiers.map(async (idOrSlug) => {
                    const result = await checkModAvailability(idOrSlug, targetMcVersion, targetLoader);
                    completedRequests++;
                    const progress = (completedRequests / totalRequests) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}% (${completedRequests}/${totalRequests})`;
                    await delay(210);
                    return result;
                });

                const modCheckResults = await Promise.all(modCheckPromises);

                allModResults = modCheckResults.filter(result => result !== null).concat(extractedOverrides);

                applyFilters();
                displayStatusMessage(`Check completed for ${modCheckResults.filter(m => m.type === 'mod').length} mods and ${extractedOverrides.length} overrides.`, 'var(--success-color)');

            } catch (error) {
                console.error('Error during update check:', error);
                displayStatusMessage(`An error occurred: ${error.message}. Check the console for details.`, 'var(--error-color)');
            } finally {
                checkButton.disabled = false;
                mrpackUploadInput.disabled = false;
                targetLoaderSelect.disabled = false;
                targetMcVersionSelect.disabled = false;
                progressBarContainer.style.display = 'none';
            }
        }

        async function processMrpackFile(file) {
            const zip = await JSZip.loadAsync(file);
            const modrinthIndexFile = zip.file('modrinth.index.json');

            if (!modrinthIndexFile) {
                throw new Error('modrinth.index.json not found in the .mrpack file.');
            }

            const modrinthIndexJson = await modrinthIndexFile.async('text');
            const modpackData = JSON.parse(modrinthIndexJson);

            const extractedModIdentifiers = [];
            const extractedOverrides = [];

            if (modpackData.files && Array.isArray(modpackData.files)) {
                modpackData.files.forEach(fileEntry => {
                    if (fileEntry.path && fileEntry.path.startsWith('mods/')) {
                        let projectId = null;

                        if (fileEntry.modrinth && fileEntry.modrinth.projectId) {
                            projectId = fileEntry.modrinth.projectId;
                        }
                        else if (fileEntry.downloads && fileEntry.downloads.length > 0) {
                            const downloadUrl = fileEntry.downloads[0];
                            const match = downloadUrl.match(/modrinth\.com\/data\/([a-zA-Z0-9]+)\//);
                            if (match && match[1]) {
                                projectId = match[1];
                            }
                        }

                        if (projectId) {
                            extractedModIdentifiers.push(projectId);
                        } else {
                            const fileName = fileEntry.path.split('/').pop();
                            extractedOverrides.push({
                                name: fileName,
                                id: fileName,
                                available: false,
                                link: null,
                                statusText: 'Override / Local File',
                                type: 'override'
                            });
                        }
                    }
                });
            }
            return { modIdentifiers: extractedModIdentifiers, overrides: extractedOverrides };
        }

        async function checkModAvailability(idOrSlug, targetMcVersion, targetLoader) {
            const existingOverride = allModResults.find(mod => mod.id === idOrSlug && mod.type === 'override');
            if (existingOverride) {
                return existingOverride;
            }

            const modrinthApiBase = 'https://api.modrinth.com/v2/project/';
            const apiUrl = `${modrinthApiBase + idOrSlug}`;
            const versionsUrl = `${modrinthApiBase + idOrSlug + '/version'}`;

            try {
                const projectResponse = await fetch(apiUrl);
                if (!projectResponse.ok) {
                    console.warn(`Project ${idOrSlug} not found or API error: ${projectResponse.status}`);
                    return { name: `${idOrSlug} (Not Found)`, id: idOrSlug, available: false, link: null, statusText: 'Not Found', type: 'mod' };
                }
                const projectData = await projectResponse.json();
                const modName = projectData.title || idOrSlug;
                const modLink = `https://modrinth.com/mod/${projectData.slug || idOrSlug}`;

                const allVersionsResponse = await fetch(versionsUrl);
                if (!allVersionsResponse.ok) {
                    console.warn(`Could not load versions for ${modName}: ${allVersionsResponse.status}`);
                    return { name: modName, id: idOrSlug, available: false, link: modLink, statusText: 'Error Fetching Versions', type: 'mod' };
                }
                const allVersions = await allVersionsResponse.json();

                let isAvailable = false;

                const targetGameVersionsToCheck = [targetMcVersion];
                if (targetMcVersion.includes('.')) {
                    const majorVersion = targetMcVersion.split('.').slice(0, 2).join('.');
                    if (majorVersion !== targetMcVersion) {
                        targetGameVersionsToCheck.push(majorVersion);
                    }
                }

                for (const version of allVersions) {
                    const hasTargetLoader = version.loaders.includes(targetLoader);
                    const hasCompatibleGameVersion = version.game_versions.some(gv => targetGameVersionsToCheck.includes(gv));

                    if (hasTargetLoader && hasCompatibleGameVersion) {
                        isAvailable = true;
                        break;
                    }
                }

                const statusText = isAvailable ? 'Available' : 'Not Available';

                return { name: modName, id: idOrSlug, available: isAvailable, link: modLink, statusText: statusText, type: 'mod' };

            } catch (error) {
                console.error(`Error processing mod ${idOrSlug}:`, error);
                return { name: `${idOrSlug} (API Error)`, id: idOrSlug, available: false, link: null, statusText: 'API Error', type: 'mod' };
            }
        }

        function applyFilters() {
            const nameFilter = filterNameInput.value.toLowerCase();
            const availabilityFilter = filterAvailabilitySelect.value;

            const filteredResults = allModResults.filter(mod => {
                const nameMatch = mod.name.toLowerCase().includes(nameFilter);

                let availabilityMatch = true;
                if (availabilityFilter === 'available') {
                    availabilityMatch = mod.available && mod.type === 'mod';
                } else if (availabilityFilter === 'not-available') {
                    availabilityMatch = !mod.available && mod.type === 'mod' && mod.statusText === 'Not Available';
                } else if (availabilityFilter === 'other-issues') {
                    availabilityMatch = mod.type === 'override' || mod.statusText === 'Not Found' || mod.statusText === 'API Error' || mod.statusText === 'Error Fetching Versions';
                }

                return nameMatch && availabilityMatch;
            });

            displayResults(filteredResults);
        }

        function displayResults(results) {
            resultsBody.innerHTML = '';

            if (results.length === 0 && allModResults.length > 0) {
                const row = resultsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = 'No mods match the current filters.';
                cell.style.textAlign = 'center';
                cell.style.fontStyle = 'italic';
                return;
            }
            if (results.length === 0 && allModResults.length === 0 && !statusMessage.textContent.includes('Checking') && !statusMessage.textContent.includes('Processing')) {
                const row = resultsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.textContent = 'No mods checked yet or none found.';
                cell.style.textAlign = 'center';
                cell.style.fontStyle = 'italic';
                return;
            }

            results.forEach(mod => {
                const row = resultsBody.insertRow();
                row.className = (mod.type === 'override' || mod.statusText === 'Not Found' || mod.statusText === 'API Error' || mod.statusText === 'Error Fetching Versions') ? 'other-issue' : (mod.available ? 'available' : 'not-available');

                const nameCell = row.insertCell();
                const statusCell = row.insertCell();
                const linkCell = row.insertCell();

                nameCell.textContent = mod.name;
                statusCell.textContent = mod.statusText;

                if (mod.link && (mod.type === 'mod' || mod.statusText === 'Not Available')) {
                    const link = document.createElement('a');
                    link.href = mod.link;
                    link.textContent = 'Modrinth Page';
                    link.target = '_blank';
                    linkCell.appendChild(link);
                } else {
                    linkCell.textContent = '-';
                }
            });
        }

        function displayStatusMessage(message, color) {
            statusMessage.textContent = message;
            statusMessage.style.color = color;
        }

        document.addEventListener('DOMContentLoaded', populateMinecraftVersions);
    </script>
</body>
</html>
